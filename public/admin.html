<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Rental Admin</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        
        /* Action buttons in tables */
        .action-bt-group { display: flex; gap: 8px; }
        .action-btn { 
            width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 6px; border: 1px solid var(--border); 
            background: white; cursor: pointer; transition: all 0.2s;
        }
        .action-btn:hover { background: var(--secondary); transform: translateY(-1px); }
        .btn-green { color: #166534; border-color: #bbf7d0; background: #f0fdf4; }
        .btn-green:hover { background: #dcfce7; }
        .btn-red { color: #b91c1c; border-color: #fecaca; background: #fef2f2; }
        .btn-red:hover { background: #fee2e2; }

       /* Map adjustment */
       .leaflet-container { font-family: inherit; z-index: 1; }
    </style>
</head>
<body>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-brand">
                <i class="ph ph-steering-wheel" style="font-size:28px;"></i>
                <span>SmartRental</span>
            </div>
            
            <nav class="sidebar-menu">
                <button class="sidebar-link active" onclick="switchTab('monitoring')">
                    <i class="ph ph-monitor" style="font-size:18px;"></i> Monitoring
                </button>
                <button class="sidebar-link" onclick="switchTab('cars')">
                    <i class="ph ph-car" style="font-size:18px;"></i> Armada Mobil
                </button>
                <button class="sidebar-link" onclick="switchTab('rentals'); loadRentals()">
                    <i class="ph ph-receipt" style="font-size:18px;"></i> Peminjaman
                    <span id="pending-count" class="badge badge-warning" style="margin-left:auto; display:none;">0</span>
                </button>
                <button class="sidebar-link" onclick="switchTab('users'); loadUsers()">
                    <i class="ph ph-users" style="font-size:18px;"></i> Pengguna
                    <span id="pending-users-count" class="badge badge-warning" style="margin-left:auto; display:none;">0</span>
                </button>
            </nav>

            <div style="padding: 24px;">
                <button onclick="logout()" class="btn btn-destructive" style="width:100%; gap:8px;">
                    <i class="ph ph-sign-out" style="font-size:18px;"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div>
                    <h2 style="font-size:24px; font-weight:700; letter-spacing:-0.5px; margin:0 0 4px 0;">Dashboard Admin</h2>
                    <p style="color:var(--muted-foreground); margin:0; font-size:14px;">Pantau armada dan kelola peminjaman secara real-time.</p>
                </div>
                <div class="user-avatar" style="background:var(--primary); color:white;">A</div>
            </header>

            <!-- 1. MONITORING -->
            <div id="monitoring" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="ph ph-car-profile"></i></div>
                        <div><h4 style="margin:0; font-size:24px;" id="total-cars">0</h4><p style="margin:0; color:var(--muted-foreground); font-size:13px;">Total Armada</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="ph ph-check-circle"></i></div>
                        <div><h4 style="margin:0; font-size:24px;" id="ready-cars">0</h4><p style="margin:0; color:var(--muted-foreground); font-size:13px;">Tersedia</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red"><i class="ph ph-warning-circle"></i></div>
                        <div><h4 style="margin:0; font-size:24px;" id="alert-cars">0</h4><p style="margin:0; color:var(--muted-foreground); font-size:13px;">Alerts</p></div>
                    </div>
                </div>

                <div class="card" style="padding:0; overflow:hidden; margin-bottom: 30px; border-radius:12px;">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>

                <h3 style="margin-bottom:16px;">Status Armada Live</h3>
                <div id="car-list" class="monitor-grid"></div>
            </div>

            <!-- 2. MANAJEMEN MOBIL -->
            <div id="cars" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h3 style="margin:0;">Daftar Mobil</h3>
                    <button class="btn btn-primary" onclick="openCarModal()">+ Tambah Mobil</button>
                </div>
                
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="data-table">
                        <thead><tr><th>Kendaraan</th><th>Plat Nomor</th><th>Device ID</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody id="cars-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. RENTAL REQUESTS -->
            <div id="rentals" class="tab-content">
                <h3 style="margin-bottom:24px;">Permintaan Peminjaman</h3>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="data-table">
                        <thead><tr><th>Peminjam</th><th>Kendaraan</th><th>Status</th><th>Waktu</th><th>Aksi</th></tr></thead>
                        <tbody id="rentals-table-body">
                             <tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted-foreground)">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. USER MANAGEMENT -->
            <div id="users" class="tab-content">
                <h3 style="margin-bottom:24px;">Manajemen Pengguna</h3>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="data-table">
                        <thead><tr><th>User Info</th><th>Kontak</th><th>Status</th><th>Bergabung</th><th>Aksi</th></tr></thead>
                        <tbody id="users-table-body">
                             <tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted-foreground)">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL ADD CAR -->
    <div id="car-modal" class="modal">
        <div class="card" style="width:400px; max-width:90%; padding:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Tambah Mobil Baru</h3>
                <button onclick="document.getElementById('car-modal').classList.remove('active')" style="background:none; border:none; cursor:pointer;"><i class="ph ph-x" style="font-size:20px;"></i></button>
            </div>
            
            <div style="display:grid; gap:16px;">
                <div>
                    <label class="form-label">Nama Mobil</label>
                    <input type="text" id="car-name" class="form-input" placeholder="Contoh: Toyota Avanza">
                </div>
                <div>
                     <label class="form-label">Plat Nomor</label>
                     <input type="text" id="car-plate" class="form-input" placeholder="B 1234 ABC">
                </div>
                <div>
                     <label class="form-label">Device ID (IoT)</label>
                     <input type="text" id="car-device" class="form-input" placeholder="MOBIL_01">
                </div>
                <div>
                     <label class="form-label">Foto Mobil</label>
                     <input type="file" id="car-image" class="form-input" accept="image/*" style="padding-top:8px;">
                </div>
                <button onclick="saveCar()" class="btn btn-primary" style="margin-top:8px; width:100%;">Simpan Data</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        function logout() {
            Swal.fire({
                title: 'Keluar?', text: "Anda akan mengakhiri sesi admin.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#f4f4f5',
                confirmButtonText: 'Ya, Keluar', cancelButtonText: 'Batal',
                customClass: { popup: 'swal-popup-custom', cancelButton: 'swal-cancel-custom' }
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('token');
                    window.location.href = '/';
                }
            });
        }

        // --- NAVIGATION ---
        function switchTab(id) {
            // Content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Sidebar Active State
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            // Find the button calling this or by index... easier to use index or query based on onclick text
            // Simple mapping since we know order: 0=monitor, 1=cars, 2=rentals, 3=users
            const index = ['monitoring', 'cars', 'rentals', 'users'].indexOf(id);
            if(index >= 0) document.querySelectorAll('.sidebar-link')[index].classList.add('active');

            // Specific Inits
            if(id === 'cars') loadCarsTable();
            if(id === 'monitoring' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        // --- MAP ---
        let map = L.map('map', {zoomControl: false}).setView([-6.2, 106.8], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        let markers = {};
        let boundsInitialized = false;

        // --- MONITORING SOCKET ---
        const socket = io({ auth: { token } });
        
        socket.on('update_all_cars', (cars) => {
            const container = document.getElementById('car-list');
            if(!container) return;
            container.innerHTML = '';
            
            let total = 0, ready = 0, alerts = 0;
            const carArray = Object.values(cars);
            total = carArray.length;
            let activeLatLngs = [];

            carArray.forEach(car => {
                // Map Marker
                if (car.lat && car.lng) {
                    const lat = parseFloat(car.lat);
                    const lng = parseFloat(car.lng);
                    activeLatLngs.push([lat, lng]);

                    const popupContent = `
                        <div style="font-family:'Inter', sans-serif;">
                            <b style="font-size:14px;">${car.name}</b><br>
                            <span style="color:#64748b; font-size:12px;">${car.plate}</span><br>
                            <div style="margin-top:4px; font-size:12px;">Kecepatan: <b>${car.speed} km/h</b></div>
                        </div>
                    `;

                    if (markers[car.id]) {
                        markers[car.id].setLatLng([lat, lng]).setPopupContent(popupContent);
                    } else {
                        markers[car.id] = L.marker([lat, lng]).addTo(map).bindPopup(popupContent);
                    }
                } else {
                    if (markers[car.id]) { map.removeLayer(markers[car.id]); delete markers[car.id]; }
                }

                if(car.status === 'TERSEDIA') ready++;
                if(car.alert === 'OUT_OF_BOUNDS' || car.isOverSpeed) alerts++;

                // Status Badge Color
                let statusBadge = `<span class="badge" style="background:#f4f4f5; color:#71717a">Offline</span>`;
                if(car.status === 'TERSEDIA') statusBadge = `<span class="badge badge-success">Tersedia</span>`;
                if(car.status === 'DISEWA') statusBadge = `<span class="badge" style="background:#dbeafe; color:#2563eb; border-color:#bfdbfe">Disewa</span>`;
                if(car.alert === 'OUT_OF_BOUNDS') statusBadge = `<span class="badge badge-warning">Luar Zona</span>`;

                const div = document.createElement('div');
                div.className = 'monitor-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div>
                            <div style="font-weight:700; font-size:16px;">${car.name || car.id}</div>
                            <div style="color:var(--muted-foreground); font-size:12px; font-family:monospace;">${car.plate}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
                        <div style="background:var(--background); padding:8px; border-radius:6px;">
                            <div style="color:var(--muted-foreground); font-size:11px;">Kecepatan</div>
                            <div style="font-weight:600; ${car.speed > 80 ? 'color:var(--destructive)' : ''}">${car.speed} km/h</div>
                        </div>
                        <div style="background:var(--background); padding:8px; border-radius:6px;">
                            <div style="color:var(--muted-foreground); font-size:11px;">Sinyal</div>
                            <div style="font-weight:600;">${car.networkStatus || '4G'}</div>
                        </div>
                        <div style="background:var(--background); padding:8px; border-radius:6px; grid-column: span 2;">
                           <div style="color:var(--muted-foreground); font-size:11px;">Perangkat</div>
                           <div style="display:flex; align-items:center; gap:6px;">
                               <i class="ph ph-device-mobile" style="color:var(--primary)"></i>
                               <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${car.connectedDevice || '-'}</span>
                           </div>
                        </div>
                    </div>

                    ${(car.alert === 'OUT_OF_BOUNDS' || car.speed > 100) ? `
                        <div style="margin-top: 12px; padding: 10px; background: #fee2e2; border-radius: 6px; color: var(--destructive); font-size: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-warning-circle" style="font-size: 16px;"></i>
                            <b>PERINGATAN:</b> ${car.alert === 'OUT_OF_BOUNDS' ? 'Mobil Keluar Zona Aman!' : 'Kecepatan Tinggi!'}
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });

            if (activeLatLngs.length > 0 && !boundsInitialized) {
                map.fitBounds(L.latLngBounds(activeLatLngs), { padding: [50, 50], maxZoom: 15 });
                boundsInitialized = true;
            }

            document.getElementById('total-cars').innerText = total;
            document.getElementById('ready-cars').innerText = ready;
            document.getElementById('alert-cars').innerText = alerts;
        });

        // --- CARS CRUD ---
        async function loadCarsTable() {
            try {
                const res = await fetch('/api/cars', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                document.getElementById('cars-table-body').innerHTML = data.map(c => `
                    <tr>
                        <td>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <img src="${c.image_url || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:6px; object-fit:cover;">
                                <b>${c.name}</b>
                            </div>
                        </td>
                        <td><span style="font-family:monospace; background:var(--secondary); padding:2px 6px; border-radius:4px; font-size:13px;">${c.plate_number}</span></td>
                        <td>${c.device_id}</td>
                        <td><span class="badge ${c.status === 'TERSEDIA' ? 'badge-success':'badge-warning'}">${c.status}</span></td>
                        <td>
                            <button class="action-btn btn-red" onclick="deleteCar('${c.id}')" title="Hapus"><i class="ph ph-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function openCarModal() { document.getElementById('car-modal').classList.add('active'); }
        
        async function saveCar() {
            const name = document.getElementById('car-name').value;
            const plate = document.getElementById('car-plate').value;
            const device = document.getElementById('car-device').value;
            const imageInput = document.getElementById('car-image');

            if(!name || !plate || !device) return Swal.fire('Error', 'Mohon lengkapi semua data', 'error');

            const formData = new FormData();
            formData.append('name', name);
            formData.append('plate_number', plate);
            formData.append('device_id', device);
            if(imageInput.files[0]) formData.append('image', imageInput.files[0]);

            try {
                const res = await fetch('/api/cars', { method: 'POST', headers: {'Authorization': 'Bearer ' + token}, body: formData });
                if(res.ok) {
                    Swal.fire('Berhasil', 'Mobil ditambahkan', 'success');
                    document.getElementById('car-modal').classList.remove('active');
                    loadCarsTable();
                    // Reset form
                    document.getElementById('car-name').value = '';
                    document.getElementById('car-plate').value = '';
                    document.getElementById('car-device').value = '';
                    document.getElementById('car-image').value = '';
                } else {
                    Swal.fire('Gagal', 'Terjadi kesalahan saat menyimpan', 'error');
                }
            } catch(e) { console.error(e); }
        }

        async function deleteCar(id) {
            Swal.fire({
                title: 'Hapus Mobil?', text: "Data tidak bisa dikembalikan.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#f4f4f5', confirmButtonText: 'Ya, Hapus'
            }).then(async (res) => {
                if(res.isConfirmed) {
                    await fetch(`/api/cars/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                    loadCarsTable();
                    Swal.fire('Terhapus', 'Mobil telah dihapus', 'success');
                }
            });
        }

        // --- RENTALS ---
        async function loadRentals() {
            try {
                const res = await fetch('/api/rentals/pending', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                
                const counter = document.getElementById('pending-count');
                if(data.length > 0) { counter.innerText = data.length; counter.style.display = 'inline-block'; }
                else { counter.style.display = 'none'; }

                const tbody = document.getElementById('rentals-table-body');
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color:var(--muted-foreground)">Tidak ada permintaan baru.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(r => `
                    <tr>
                        <td><b>${r.username || 'Unknown'}</b></td>
                        <td>${r.name}<br><span style="color:var(--muted-foreground); font-size:12px;">${r.plate_number}</span></td>
                        <td><span class="badge badge-warning">${r.status}</span></td>
                        <td>${new Date(r.created_at).toLocaleString('id-ID')}</td>
                        <td>
                            <div class="action-bt-group">
                                <button class="action-btn btn-green" onclick="processRental('${r.id}', 'APPROVE')" title="Terima"><i class="ph ph-check"></i></button>
                                <button class="action-btn btn-red" onclick="processRental('${r.id}', 'REJECT')" title="Tolak"><i class="ph ph-x"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch(e) { console.error(e); }
        }

        async function processRental(id, action) {
             const res = await fetch('/api/rentals/approve', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                 body: JSON.stringify({ rental_id: id, action })
             });
             if(res.ok) {
                 Swal.fire('Berhasil', 'Status diperbarui', 'success');
                 loadRentals();
             } else {
                 Swal.fire('Gagal', 'Gagal memproses permintaan', 'error');
             }
        }

        // --- USERS ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                
                const pending = data.filter(u => u.status === 'PENDING').length;
                const counter = document.getElementById('pending-users-count');
                if(pending > 0) { counter.innerText = pending; counter.style.display = 'inline-block'; }
                else { counter.style.display = 'none'; }

                document.getElementById('users-table-body').innerHTML = data.map(u => `
                     <tr>
                        <td>
                            <div style="font-weight:600;">${u.name || u.username}</div>
                            <div style="font-size:12px; color:var(--muted-foreground);">ID: ${u.id}</div>
                        </td>
                        <td>
                            ${u.email || '-'}<br>
                            <span style="font-size:12px; color:var(--muted-foreground);">${u.phone || '-'}</span>
                        </td>
                        <td>
                            <span class="badge ${u.status=== 'ACTIVE'?'badge-success':(u.status==='PENDING'?'badge-warning':'badge-danger')}">
                                ${u.status}
                            </span>
                        </td>
                        <td>${new Date(u.created_at).toLocaleDateString('id-ID')}</td>
                        <td>
                            ${u.status === 'PENDING' ? `
                            <div class="action-bt-group">
                                <button class="action-btn btn-green" onclick="verifyUser('${u.id}', 'APPROVE')" title="Setujui"><i class="ph ph-check"></i></button>
                                <button class="action-btn btn-red" onclick="verifyUser('${u.id}', 'REJECT')" title="Tolak"><i class="ph ph-x"></i></button>
                            </div>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch(e) { console.error(e); }
        }

        async function verifyUser(id, action) {
            Swal.fire({
                title: 'Verifikasi Pengguna', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Proses'
            }).then(async (res) => {
                if(res.isConfirmed) {
                     await fetch('/api/admin/users/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ user_id: id, action })
                    });
                    loadUsers();
                    Swal.fire('Berhasil', '', 'success');
                }
            })
        }
        
        // Initial Loads
        loadRentals();
        loadUsers();
    </script>
</body>
</html>
