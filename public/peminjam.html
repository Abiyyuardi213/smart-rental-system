<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Saya - Smart Rental</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="main.css">
    <style>
        .view-section { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Gauge styles local unless moved to main.css */
        .gauge-container {
            width: 220px; height: 220px;
            margin: 0 auto 24px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: conic-gradient(from 180deg, var(--primary) 0%, var(--secondary) 0%);
            transition: background 0.5s ease-out;
        }
        
        .gauge-inner {
            position: absolute;
            width: 180px; height: 180px;
            background: var(--card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .status-hero {
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
        }
        
        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .car-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s, transform 0.2s;
        }

        .car-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Navbar Placeholder -->
        <div id="navbar-container"></div>

        <!-- Warning Banner -->
        <div id="account-pending-warning" style="display:none; background:#fff7ed; border:1px solid #fed7aa; padding:16px; border-radius:var(--radius); margin-bottom:24px; display:flex; gap:12px; align-items:start;">
             <i class="ph ph-warning-circle" style="color:#f97316; font-size:20px; padding-top:2px;"></i>
             <div>
                 <h4 style="margin:0 0 4px 0; color:#9a3412; font-size:14px;">Akun Belum Dikonfirmasi</h4>
                 <p style="margin:0; font-size:13px; color:#c2410c; line-height:1.4;">
                     Beberapa fitur dibatasi hingga Admin menyetujui akun Anda.
                 </p>
             </div>
        </div>

        <!-- VIEW: BROWSE (Home) -->
        <div id="view-home" class="view-section" style="display:block;">
            
            <!-- Sub-view: Car List -->
            <div id="view-browse">
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 20px; font-weight: 600; letter-spacing:-0.5px;">Pilih Mobil</h2>
                    <p style="color: var(--muted-foreground); font-size: 14px;">Armada tersedia untuk disewa hari ini.</p>
                </div>
                <div id="available-list" class="car-grid">
                     <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted-foreground);">
                         <i class="ph ph-spinner-gap" style="font-size: 24px; animation: spin 1s infinite linear;"></i><br>Nomuat data...
                     </div>
                </div>
            </div>

            <!-- VIEW: PENDING RENTAL -->
            <div id="view-pending" class="status-hero card" style="display:none;">
                <div style="width:64px; height:64px; background:#fef3c7; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <i class="ph ph-hourglass-high" style="font-size: 32px; color: #d97706;"></i>
                </div>
                <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Menunggu Persetujuan</h2>
                <p style="color: var(--muted-foreground); font-size: 14px; line-height:1.5;">Admin sedang memproses permintaan sewa Anda.<br>Mohon tunggu notifikasi selanjutnya.</p>
                <div style="margin-top:24px;">
                   <button onclick="checkStatus()" class="btn btn-primary">Cek Status Terbaru</button>
                </div>
            </div>

            <!-- VIEW: ACTIVE MONITOR -->
            <div id="view-monitor" class="status-hero card" style="display:none; max-width: 600px;">
                 <h2 id="car-title" style="margin:0; font-size:20px; font-weight:700;">--</h2>
                 <div class="badge badge-success" style="margin: 8px 0 24px;">SEDANG DISEWA</div>
                 
                 <div class="gauge-container" id="gauge">
                     <div class="gauge-inner">
                         <div class="speed-value" id="speed" style="font-size: 48px; font-weight: 800; line-height:1;">0</div>
                         <span style="font-size: 13px; color: var(--muted-foreground); font-weight:500;">KM/H</span>
                     </div>
                 </div>
                 
                 <div id="alert-box" style="display:none; padding:12px; background: #fef2f2; border: 1px solid #fee2e2; border-radius:var(--radius); color: var(--destructive); margin-bottom:20px; font-size:14px; font-weight:500;">
                      ⚠️ <span id="alert-msg">PERINGATAN!</span>
                 </div>
                 
                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:24px;">
                      <div style="background:var(--secondary); padding:12px; border-radius:var(--radius);">
                          <div style="font-size:12px; color:var(--muted-foreground);">Plat Nomor</div>
                          <div id="car-plate" style="font-weight:600; font-family:monospace;">--</div>
                      </div>
                      <div style="background:var(--secondary); padding:12px; border-radius:var(--radius);">
                          <div style="font-size:12px; color:var(--muted-foreground);">GPS Status</div>
                          <div id="gps-status" style="font-weight:600; color:var(--primary);">Menunggu...</div>
                      </div>
                 </div>

                 <button onclick="finishRental()" class="btn btn-destructive" style="width:100%;">
                     Kembalikan Mobil
                 </button>
            </div>
        </div>

    </div>

    <!-- RENTAL CONFIRMATION MODAL -->
    <div id="rental-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(4px);">
        <div class="card" style="width:400px; max-width:90%; padding:24px; animation: scaleIn 0.2s ease-out;">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:64px; height:64px; background:#dbeafe; color:#2563eb; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                    <i class="ph ph-steering-wheel" style="font-size:32px;"></i>
                </div>
                <h3 style="font-size:18px; font-weight:700; margin-bottom:8px;">Konfirmasi Sewa</h3>
                <p style="color:var(--muted-foreground); margin:0;">Anda akan mengajukan sewa untuk:</p>
            </div>
            
            <div style="background:var(--secondary); padding:16px; border-radius:8px; margin-bottom:24px; text-align:center;">
                <h4 id="modal-car-name" style="margin:0 0 4px 0; font-size:16px;">Toyota Avanza</h4>
                <div id="modal-car-plate" style="font-family:monospace; color:var(--muted-foreground);">B 1234 ABC</div>
            </div>

            <div style="display:flex; gap:12px;">
                <button onclick="closeRentalModal()" class="btn" style="flex:1; background:var(--secondary); color:var(--foreground);">Batal</button>
                <button id="btn-confirm-rental" onclick="confirmRental()" class="btn btn-primary" style="flex:1;">Ya, Sewa Sekarang</button>
            </div>
        </div>
    </div>
    <!-- RETURN CONFIRMATION MODAL -->
    <div id="return-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(4px);">
        <div class="card" style="width:400px; max-width:90%; padding:24px; animation: scaleIn 0.2s ease-out;">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:64px; height:64px; background:#fee2e2; color:#ef4444; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                    <i class="ph ph-arrow-u-down-left" style="font-size:32px;"></i>
                </div>
                <h3 style="font-size:18px; font-weight:700; margin-bottom:8px;">Kembalikan Mobil?</h3>
                <p style="color:var(--muted-foreground); margin:0;">Apakah Anda yakin ingin mengakhiri sesi sewa ini?</p>
            </div>
            
            <div style="display:flex; gap:12px;">
                <button onclick="closeReturnModal()" class="btn" style="flex:1; background:var(--secondary); color:var(--foreground);">Batal</button>
                <button id="btn-confirm-return" onclick="confirmReturn()" class="btn btn-destructive" style="flex:1;">Ya, Kembalikan</button>
            </div>
        </div>
    </div>

    <style>
        #rental-modal.active, #return-modal.active { display: flex !important; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>

    <script src="navbar.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        // Initialize Navbar
        renderNavbar('home');

        // Status Logic
        async function fetchProfileForHeader() {
            // Need to fetch profile just to update the name in header and handle generic account status
            try {
                const res = await fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + token } });
                const user = await res.json();
                updateHeaderUser(user.name || user.username);

                const warningEl = document.getElementById('account-pending-warning');
                if (user.status === 'PENDING') {
                    warningEl.style.display = 'flex';
                } else {
                    warningEl.style.display = 'none';
                    localStorage.removeItem('accountStatus');
                }
            } catch(e) {}
        }

        async function checkStatus() {
            try {
                fetchProfileForHeader();

                const res = await fetch('/api/my-rental-status', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                
                // Reset views
                document.getElementById('view-browse').style.display = 'none';
                document.getElementById('view-pending').style.display = 'none';
                document.getElementById('view-monitor').style.display = 'none';
                
                if (data.status !== 'ACTIVE') stopGPS();

                if (data.status === 'ACTIVE') {
                    document.getElementById('view-monitor').style.display = 'block';
                    document.getElementById('view-home').style.display = 'block'; // wrapper
                    startSocket();
                } else if (data.status === 'PENDING') {
                    document.getElementById('view-pending').style.display = 'block';
                    document.getElementById('view-home').style.display = 'block';
                } else {
                    document.getElementById('view-browse').style.display = 'block';
                    document.getElementById('view-home').style.display = 'block';
                    loadAvailableCars();
                }
            } catch (e) { console.error(e); }
        }

        // ... existing code ...
        
        async function loadAvailableCars() {
            const res = await fetch('/api/cars/available');
            const data = await res.json();
            const container = document.getElementById('available-list');
            
            if(data.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:gray">Tidak ada mobil tersedia.</div>';
                return;
            }

            container.innerHTML = data.map(car => `
                <div class="car-item card" style="display:flex; flex-direction:column; padding:16px;">
                    <div style="width:100%; height:140px; background:var(--secondary); border-radius:6px; overflow:hidden; margin-bottom:16px;">
                         <img src="${car.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <div style="flex:1;">
                        <h3 style="font-size:16px; font-weight:600; margin:0 0 4px 0;">${car.name}</h3>
                        <p style="margin:0; font-size:13px; color:var(--muted-foreground); font-family:monospace; background:var(--secondary); padding:4px 8px; border-radius:4px; display:inline-block;">${car.plate_number}</p>
                    </div>
                    <button class="btn btn-primary" onclick="openRentalModal('${car.id}', '${car.name}', '${car.plate_number}')" style="margin-top:16px; width:100%;">Sewa Sekarang</button>
                </div>
            `).join('');
        }

        let selectedCarId = null;

        function openRentalModal(id, name, plate) {
            selectedCarId = id;
            document.getElementById('modal-car-name').innerText = name;
            document.getElementById('modal-car-plate').innerText = plate;
            document.getElementById('rental-modal').classList.add('active');
        }

        function closeRentalModal() {
            document.getElementById('rental-modal').classList.remove('active');
            selectedCarId = null;
        }

        async function confirmRental() {
            if(!selectedCarId) return;
            
            const btn = document.getElementById('btn-confirm-rental');
            btn.disabled = true;
            btn.innerText = 'Memproses...';

            try {
                const res = await fetch('/api/rentals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, car_db_id: selectedCarId })
                });
                
                if (res.ok) {
                    closeRentalModal();
                    Swal.fire('Permintaan Terkirim', 'Mohon tunggu persetujuan admin.', 'success');
                    checkStatus();
                } else {
                    Swal.fire('Gagal', 'Terjadi kesalahan.', 'error');
                }
            } catch (e) {
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Ya, Sewa Sekarang';
            }
        }

        function finishRental() {
            document.getElementById('return-modal').classList.add('active');
        }
        
        function closeReturnModal() {
            document.getElementById('return-modal').classList.remove('active');
        }
        
        async function confirmReturn() {
            const btn = document.getElementById('btn-confirm-return');
            btn.disabled = true;
            btn.innerText = 'Memproses...';

            try {
                const res = await fetch('/api/rentals/return', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    closeReturnModal();
                    Swal.fire('Berhasil', 'Mobil telah dikembalikan.', 'success');
                    checkStatus();
                } else {
                    Swal.fire('Gagal', 'Gagal memproses pengembalian.', 'error');
                }
            } catch (error) { 
                console.error(error); 
                Swal.fire('Error', 'Terjadi kesalahan koneksi.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Ya, Kembalikan';
            }
        }

        let socket;
        function startSocket() {
            if(socket) return;
            socket = io({ auth: { token } });
            socket.on('update_my_car', (car) => {
                document.getElementById('car-title').innerText = car.name;
                document.getElementById('car-plate').innerText = car.plate;
                document.getElementById('speed').innerText = car.speed;
                
                const val = Math.min((car.speed / 140) * 100, 100); 
                document.getElementById('gauge').style.background = `conic-gradient(from 180deg, var(--primary) ${val}%, var(--secondary) 0%)`;

                const alertBox = document.getElementById('alert-box');
                if (car.alert === "OUT_OF_BOUNDS") {
                    alertBox.style.display = 'block';
                    document.getElementById('alert-msg').innerText = "ANDA KELUAR AREA!";
                } else if (car.speed > 100) {
                     alertBox.style.display = 'block';
                    document.getElementById('alert-msg').innerText = "KECEPATAN TINGGI!";
                } else {
                    alertBox.style.display = 'none';
                }
            });
            startGPS();
        }

        let watchId = null; 
        function stopGPS() {
             if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
        }

        function startGPS() {
            stopGPS();
            const statusEl = document.getElementById('gps-status');
            if (!navigator.geolocation) { statusEl.innerText = "Tidak Didukung"; statusEl.style.color = 'red'; return; }

            statusEl.innerText = "Mencari...";
            statusEl.style.color = '#eab308';

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, speed, altitude } = pos.coords;
                    statusEl.innerText = "Terhubung"; statusEl.style.color = '#16a34a';
                    if(socket) {
                        socket.emit('client_gps_update', { lat: latitude, lng: longitude, speed: speed, alt: altitude });
                    }
                }, 
                (err) => { statusEl.innerText = "Gagal"; statusEl.style.color = '#dc2626'; }, 
                { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
            );
        }

        // Init
        checkStatus();

    </script>
</body>
</html>