<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - Smart Rental</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="main.css">
</head>
<body>

    <div class="container">
        <!-- Navbar Placeholder -->
        <div id="navbar-container"></div>

        <!-- content -->
        <div class="card profile-card">
             <div class="profile-header">
                 <div class="profile-avatar-container" style="position: relative; cursor: pointer;" onclick="document.getElementById('file-input').click()">
                     <img id="profile-img-preview" src="https://via.placeholder.com/100" class="profile-avatar">
                     <div class="avatar-overlay">
                         <i class="ph ph-camera" style="font-size: 24px; color: white;"></i>
                     </div>
                 </div>
                 <input type="file" id="file-input" hidden accept="image/*" onchange="uploadPhoto(this)">
                 <span class="badge" id="profile-status-badge">PENDING</span>
             </div>

             <div class="form-grid-2">
                 <div>
                     <label class="form-label">Nama Lengkap</label>
                     <input type="text" id="prof-name" class="form-input" placeholder="Nama Anda">
                 </div>
                 <div>
                     <label class="form-label">No Telepon</label>
                     <input type="text" id="prof-phone" class="form-input" placeholder="08xxxxx">
                 </div>
                 <div class="full-width">
                     <label class="form-label">Alamat</label>
                     <textarea id="prof-address" class="form-input" placeholder="Alamat Lengkap" rows="3"></textarea>
                 </div>
             </div>

             <div id="msg-box" class="msg-box"></div>

             <button onclick="updateProfile()" id="btn-save" class="btn btn-primary btn-block">Simpan Perubahan</button>
        </div>
    </div>

    <style>
        .profile-card {
            max-width: 700px; /* Wider for desktop */
            margin: 20px auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .profile-avatar-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--secondary);
            overflow: hidden;
            margin: 0 auto 12px;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        
        .profile-avatar-container:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .profile-avatar {
            width: 100%; height: 100%; object-fit: cover;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--foreground);
            margin-bottom: 6px;
            display: block;
        }

        .form-hint {
            font-size: 11px;
            color: var(--muted-foreground);
            margin-top: 6px;
        }

        .msg-box {
            display: none;
            padding: 12px;
            border-radius: var(--radius);
            font-size: 13px;
            text-align: center;
            margin-top: 20px;
        }

        .btn-block {
            width: 100%;
            margin-top: 24px;
        }

        textarea.form-input {
            height: auto;
            min-height: 80px;
            resize: vertical;
        }
    </style>

    <script src="navbar.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        // Initialize Navbar
        renderNavbar('profile');

        async function loadProfile() {
            try {
                const res = await fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + token } });
                const user = await res.json();
                
                document.getElementById('prof-name').value = user.name || '';
                document.getElementById('prof-phone').value = user.phone || '';
                document.getElementById('prof-address').value = user.address || '';
                
                if(user.profile_pic) document.getElementById('profile-img-preview').src = user.profile_pic;
                
                const badge = document.getElementById('profile-status-badge');
                badge.innerText = user.status;
                badge.className = `badge ${user.status === 'ACTIVE' ? 'badge-success' : 'badge-warning'}`;
                
                // Update navbar user name
                updateHeaderUser(user.name || user.username);
            } catch (e) { console.error(e); }
        }

        async function uploadPhoto(input) {
            if (!input.files || !input.files[0]) return;
            
            const formData = new FormData();
            formData.append('profile_pic', input.files[0]);

            // Show loading state on avatar
            const preview = document.getElementById('profile-img-preview');
            const originalSrc = preview.src;
            preview.style.opacity = '0.5';
            
            try {
                const res = await fetch('/api/profile/upload-pic', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    preview.src = data.profile_pic;
                    Swal.fire({
                         icon: 'success',
                         title: 'Foto Diperbarui',
                         text: 'Foto profil berhasil diganti.',
                         timer: 2000,
                         showConfirmButton: false
                    });
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                preview.src = originalSrc;
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Upload',
                    text: e.message
                });
            } finally {
                preview.style.opacity = '1';
                input.value = ''; // Reset input
            }
        }

        async function updateProfile() {
             const name = document.getElementById('prof-name').value;
             const phone = document.getElementById('prof-phone').value;
             const address = document.getElementById('prof-address').value;
             const btn = document.getElementById('btn-save');
             const msgBox = document.getElementById('msg-box');

             btn.innerText = "Menyimpan...";
             btn.disabled = true;
             
             try {
                 const res = await fetch('/api/profile/update', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                     body: JSON.stringify({ name, phone, address })
                 });
                 
                 msgBox.style.display = 'block';
                 if(res.ok) {
                     msgBox.innerText = 'Profil Berhasil Diperbarui!';
                     msgBox.style.background = '#dcfce7'; 
                     msgBox.style.color = '#15803d';
                 } else {
                     msgBox.innerText = 'Gagal memperbarui profil';
                     msgBox.style.background = '#fee2e2'; 
                     msgBox.style.color = '#b91c1c';
                 }
                 
                 loadProfile(); 
             } catch(e) { 
                 alert('Error: ' + e.message); 
             } finally {
                 btn.innerText = "Simpan Perubahan";
                 btn.disabled = false;
                 setTimeout(() => { msgBox.style.display = 'none'; }, 3000);
             }
        }

        loadProfile();
    </script>
</body>
</html>
