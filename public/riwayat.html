<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Perjalanan - Smart Rental Admin</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/admin-layout.js"></script>
    <style>
        .split-view { display: grid; grid-template-columns: 350px 1fr; gap: 24px; height: calc(100vh - 120px); }
        .history-list { overflow-y: auto; padding-right: 8px; }
        .history-item { 
            padding: 16px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 12px;
        }
        .history-item:hover { border-color: var(--primary); transform: translateY(-2px); }
        .history-item.active { border-color: var(--primary); background: var(--secondary); }
        
        .map-container { position: relative; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        #map { height: 100%; width: 100%; }
        
        .player-controls {
            position: absolute; bottom: 24px; left: 24px; right: 24px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            padding: 16px; border-radius: 12px; z-index: 1000;
            display: flex; align-items: center; gap: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        input[type=range] { flex: 1; height: 6px; border-radius: 4px; background: #e4e4e7; outline: none; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div class="admin-layout">
        <div id="sidebar-container"></div>

        <main class="admin-main">
            <header class="admin-header">
                <div>
                    <h2 style="font-size:24px; font-weight:700; letter-spacing:-0.5px; margin:0 0 4px 0;">Riwayat Perjalanan</h2>
                    <p style="color:var(--muted-foreground); margin:0; font-size:14px;">Putar ulang rute perjalanan dari transaksi yang telah selesai.</p>
                </div>
                <div class="user-avatar" style="background:var(--primary); color:white;">A</div>
            </header>

            <div class="split-view">
                <!-- LIST -->
                <div class="history-list" id="history-list">
                    <div style="text-align:center; padding:40px; color:var(--muted-foreground);">Memuat riwayat...</div>
                </div>

                <!-- MAP -->
                <div class="map-container">
                    <div id="map"></div>
                    
                    <div class="player-controls" id="player-controls" style="display:none;">
                        <button id="play-btn" class="btn btn-primary" onclick="togglePlay()" style="width:40px; height:40px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                            <i class="ph ph-play-fill" style="font-size:20px;"></i>
                        </button>
                        
                        <div style="flex:1;">
                            <input type="range" id="timeline" min="0" max="100" value="0" step="1">
                            <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:4px; color:var(--muted-foreground);">
                                <span id="current-time">00:00:00</span>
                                <span id="speed-display">0 km/h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        initAdminLayout('riwayat');
        const token = localStorage.getItem('token');
        
        // Map Init
        const map = L.map('map').setView([-6.2, 106.8], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        
        let pathLayer = null;
        let carMarker = null;
        let tripData = [];
        let isPlaying = false;
        let playInterval = null;
        let currentIndex = 0;

        // Fetch History
        async function loadHistory() {
            const res = await fetch('/api/rentals/history', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            const container = document.getElementById('history-list');
            
            if(data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted-foreground);">Belum ada riwayat perjalanan.</div>';
                return;
            }

            container.innerHTML = data.map(r => `
                <div class="history-item" onclick="loadTrip('${r.id}', this)">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:600; font-size:14px;">${r.car_name}</span>
                        <span class="badge badge-success" style="font-size:11px;">Selesai</span>
                    </div>
                    <div style="font-size:13px; color:var(--muted-foreground); margin-bottom:4px;">
                        <i class="ph ph-user"></i> ${r.user_name}
                    </div>
                    <div style="font-size:12px; color:var(--muted-foreground); font-family:monospace;">
                        ${new Date(r.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        async function loadTrip(id, el) {
            // Highlight active item
            document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            // Reset Player
            stopPlay();
            if(pathLayer) map.removeLayer(pathLayer);
            if(carMarker) map.removeLayer(carMarker);
            document.getElementById('player-controls').style.display = 'none';

            // Fetch Logs
            Swal.showLoading();
            const res = await fetch(`/api/rentals/${id}/logs`, { headers: { 'Authorization': 'Bearer ' + token } });
            tripData = await res.json();
            Swal.close();

            if(tripData.length < 2) {
                Swal.fire('Info', 'Data GPS tidak cukup untuk diputar ulang.', 'info');
                return;
            }

            // Draw Path
            const latLngs = tripData.map(p => [p.lat, p.lng]);
            pathLayer = L.polyline(latLngs, { color: 'blue', weight: 4 }).addTo(map);
            map.fitBounds(pathLayer.getBounds(), { padding: [50, 50] });

            // Init Marker
            carMarker = L.marker(latLngs[0], {
                icon: L.divIcon({ 
                    className: 'car-icon', 
                    html: '<i class="ph ph-car-profile" style="font-size:24px; color:var(--primary); background:white; border-radius:50%; padding:4px; border:2px solid var(--primary);"></i>',
                    iconSize: [32, 32], iconAnchor: [16, 16] 
                }) 
            }).addTo(map);

            // Setup Controls
            document.getElementById('player-controls').style.display = 'flex';
            const slider = document.getElementById('timeline');
            slider.max = tripData.length - 1;
            slider.value = 0;
            currentIndex = 0;
            updateDisplay(0);

            slider.oninput = (e) => {
                currentIndex = parseInt(e.target.value);
                updateDisplay(currentIndex);
            };
        }

        function updateDisplay(index) {
            const point = tripData[index];
            if(!point) return;

            carMarker.setLatLng([point.lat, point.lng]);
            document.getElementById('timeline').value = index;
            document.getElementById('current-time').innerText = new Date(point.created_at).toLocaleTimeString();
            document.getElementById('speed-display').innerText = Math.round(point.speed) + ' km/h';
        }

        function togglePlay() {
            if(isPlaying) stopPlay();
            else startPlay();
        }

        function startPlay() {
            isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<i class="ph ph-pause-fill" style="font-size:20px;"></i>';
            
            if(currentIndex >= tripData.length - 1) currentIndex = 0;

            playInterval = setInterval(() => {
                currentIndex++;
                if(currentIndex >= tripData.length) {
                    stopPlay();
                    return;
                }
                updateDisplay(currentIndex);
            }, 100); // 100ms per point
        }

        function stopPlay() {
            isPlaying = false;
            clearInterval(playInterval);
            document.getElementById('play-btn').innerHTML = '<i class="ph ph-play-fill" style="font-size:20px;"></i>';
        }

        loadHistory();
    </script>
</body>
</html>
